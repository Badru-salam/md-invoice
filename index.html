<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invoice - Konveksi Jasa Pembuatan Seragam</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #e3f2fd, #bbdefb);
      color: #333;
      margin: 0;
      padding: 0;
    }
    .container {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      padding: 30px;
      margin-top: 20px;
    }
    .header-flex {
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 3px solid #1976d2;
      padding-bottom: 10px;
      flex-wrap: wrap;
    }
    .header-left {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
    }
    .logo {
      width: 170px;
      margin-right: 15px;
    }
    .company-name h2 {
      margin: 0;
      color: #1976d2;
      font-weight: 700;
    }
    .invoice-title {
      font-size: 1.8rem;
      font-weight: bold;
      color: #1565c0;
      text-align: right;
    }
    .form-label {
      font-weight: 600;
      color: #424242;
    }
    .table th {
      background: #1976d2;
      color: #fff;
    }
    .table tbody tr:hover {
      background: #e3f2fd;
    }
    .total-row {
      font-weight: bold;
      color: #d32f2f;
      text-align: right;
    }
    .signature {
      max-width: 180px;
      margin-top: 5px;
    }
    .invoice-footer {
      display: flex;
      justify-content: space-between;
      margin-top: 40px;
      flex-wrap: wrap;
    }
    .btn {
      border-radius: 25px;
      transition: 0.3s;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .preview-mode { display: none; }

    /* CSS untuk preview PDF */
    .pdf-preview {
      font-size: 12px;
      padding: 10px;
      line-height: 1.2;
    }
    .pdf-preview .header-flex {
      padding-bottom: 5px;
    }
    .pdf-preview .logo {
      width: 80px;
    }
    .pdf-preview .company-name h2 {
      font-size: 1.2rem;
    }
    .pdf-preview .invoice-title {
      font-size: 1.4rem;
    }
    .pdf-preview .table {
      font-size: 11px;
    }
    .pdf-preview .total-row {
      font-size: 13px;
    }
    .pdf-preview .invoice-footer {
      margin-top: 20px;
    }
    .text-start p {
      margin-bottom: 4px;
      text-align: left;
    }
.pdf-preview th {
  background-color: #1976d2 !important; /* biru khas */
  color: #ffffff !important;
  text-align: center !important;
  font-weight: bold;
  padding: 6px 8px !important;
  border: 0.5px solid #f5f5f5 !important;
}

/* Isi tabel: selang-seling abu dan putih */
.pdf-preview table tr:nth-child(odd) td {
  background-color: #f5f5f5 !important; /* abu muda */
}

.pdf-preview table tr:nth-child(even) td {
  background-color: #ffffff !important; /* putih */
}


/* Keseluruhan tabel */
.pdf-preview table {
  width: 100%;
  border-collapse: collapse !important;
  font-size: 12px;
}

#pdfArea {
  width: 100%;
  max-width: 210mm; /* agar proporsional di A4 */
  margin: 0 auto;
  background: #fff;
  box-sizing: border-box;
}

@media print {
  body {
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }
}


/* Sembunyikan header utama hanya saat mode preview aktif */
.preview-mode-active #invoiceContainer > .header-flex {
  display: none !important;
}


    /* Responsif */
    @media (max-width: 768px) {
      .header-flex, .invoice-footer {
        flex-direction: column;
        text-align: center;
      }
      .invoice-title {
        text-align: center;
        margin-top: 10px;
      }
      .logo {
        width: 120px;
      }
    }


  </style>
</head>
<body>
  <div class="container" id="invoiceContainer">
    
    <!-- Header -->
    <div class="header-flex">
      <div class="header-left">
        <img src="logo.jpg" class="logo" alt="Logo">
        <div class="company-name">
          <h2>Konveksi Jasa Pembuatan Seragam</h2>
          <p>Kampung Babakan Rt.02 Rw.06 Kota Bekasi <br>Hp: 085716122202 / 08571644585</p>
        </div>
      </div>
      <div>
        <div class="invoice-title">INVOICE</div>
        <div><strong>No. Invoice:</strong> <span id="autoInvoice"></span></div>
      </div>
    </div>

    <!-- Form Mode -->
    <div id="formMode" class="mt-4">
      <form id="invoiceForm">
        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Tanggal Invoice</label>
            <input type="date" class="form-control" id="tanggal" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Kepada Yth</label>
            <input type="text" class="form-control" id="kepada" placeholder="Nama Penerima" required>
            <small class="text-muted">Di Tempat</small>
          </div>
        </div>

        <h5 class="mt-4">Produk</h5>
        <table class="table table-bordered" id="produkTable">
          <thead>
            <tr>
              <th>No</th>
              <th>Nama Produk</th>
              <th>Jumlah</th>
              <th>Harga Satuan</th>
              <th>Total</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody id="produkBody">
            <tr data-no="1">
              <td>1</td>
              <td><input type="text" class="form-control namaProduk" required></td>
              <td><input type="number" class="form-control jumlah" min="1" required></td>
              <td><input type="number" class="form-control hargaSatuan" min="0" required></td>
              <td><input type="text" class="form-control totalProduk" readonly></td>
              <td><button type="button" class="btn btn-danger btn-sm removeRow">Hapus</button></td>
            </tr>
          </tbody>
        </table>
        <button type="button" class="btn btn-primary mb-3" id="tambahProduk">Tambah Produk</button>

        <!-- <h5 class="total-row">Total Keseluruhan: Rp <span id="totalKeseluruhan">0</span></h5> -->
<!-- Tambahkan bagian ini di bawah <h5 class="total-row"> -->
<h5 class="total-row">Total Keseluruhan: Rp <span id="totalKeseluruhan">0</span></h5>

<div class="row mt-3">
  <div class="col-md-6">
    <label class="form-label">DP (Uang Muka)</label>
    <input type="number" class="form-control" id="dpInput" placeholder="Masukkan jumlah DP">
  </div>
  <div class="col-md-6">
    <label class="form-label">Sisa Pembayaran</label>
    <div id="sisaPembayaran" class="p-3 rounded text-white fw-bold" style="background:#1976d2;">Rp 0</div>
  </div>
</div>

        <div class="invoice-footer">
          <div>
            <h6>Pembayaran:</h6>
            <p>Bank BCA a/n <b>Darmin</b><br>No. Rek: <b>8415723942</b></p>
          </div>
          <div class="text-start">
            <p>Bekasi, <span id="tanggalNow"></span></p>
            <p>Hormat Kami,<br>Muda Collection</p>
            <img src="stamp.png" alt="Tanda Tangan" class="signature"><br>
            <label class="form-label mt-2">Nama Pemilik</label>
            <input type="text" class="form-control" id="namaPemilik" placeholder="Masukkan Nama Pemilik" required>
          </div>
        </div>

<div class="text-center mt-4">
  <button type="button" class="btn btn-success me-2" id="previewBtn">Preview</button>
  <button type="button" class="btn btn-warning me-2" id="saveJsonBtn">Save Data (JSON)</button>
  <label class="btn btn-info me-2 mb-0" for="uploadJsonFile">Upload File JSON</label>
  <input type="file" id="uploadJsonFile" accept=".json" hidden>
</div>

      </form>
    </div>

    <!-- Preview Mode -->
    <div id="previewMode" class="preview-mode mt-4">
      <div id="previewContent" class="pdf-preview"></div>
      <div class="text-center mt-3">
        <button class="btn btn-secondary" id="backToForm">Kembali ke Form</button>
        <button class="btn btn-success" id="downloadPdfFinal">Download PDF</button>
      </div>
    </div>
  </div>

  <script>
// === SAVE JSON ===
document.getElementById('saveJsonBtn').addEventListener('click', function () {
  const data = {
    nomorInvoice: document.getElementById('autoInvoice').textContent,
    tanggal: document.getElementById('tanggal').value,
    kepada: document.getElementById('kepada').value,
    namaPemilik: document.getElementById('namaPemilik').value,
    totalKeseluruhan: document.getElementById('totalKeseluruhan').textContent,
    produk: Array.from(document.querySelectorAll('#produkBody tr')).map(row => ({
      namaProduk: row.querySelector('.namaProduk').value,
      jumlah: row.querySelector('.jumlah').value,
      hargaSatuan: row.querySelector('.hargaSatuan').value
    }))
  };

  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `Invoice-${data.kepada.replace(/\s+/g, '_')}.json`;
  a.click();
});

// === UPLOAD JSON & LOAD TO FORM ===
document.getElementById('uploadJsonFile').addEventListener('change', function (e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function (event) {
    const data = JSON.parse(event.target.result);

    // Isi ulang form
    document.getElementById('autoInvoice').textContent = data.nomorInvoice || generateInvoiceNumber();
    document.getElementById('tanggal').value = data.tanggal || '';
    document.getElementById('kepada').value = data.kepada || '';
    document.getElementById('namaPemilik').value = data.namaPemilik || '';

    // Bersihkan produk lama
    const tbody = document.getElementById('produkBody');
    tbody.innerHTML = '';

    // Tambahkan produk dari file JSON
    (data.produk || []).forEach((p, index) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${index + 1}</td>
        <td><input type="text" class="form-control namaProduk" value="${p.namaProduk || ''}" required></td>
        <td><input type="number" class="form-control jumlah" value="${p.jumlah || 0}" min="1" required></td>
        <td><input type="number" class="form-control hargaSatuan" value="${p.hargaSatuan || 0}" min="0" required></td>
        <td><input type="text" class="form-control totalProduk" readonly></td>
        <td><button type="button" class="btn btn-danger btn-sm removeRow">Hapus</button></td>
      `;
      tbody.appendChild(tr);
    });

    attachListeners();
    calcTotal();
  };
  reader.readAsText(file);
});


    // Nomor invoice otomatis
 function generateInvoiceNumber() {
  const date = new Date();
  const romanMonths = ["I", "II", "III", "IV", "V", "VI", "VII", "VIII", "IX", "X", "XI", "XII"];
  const monthRoman = romanMonths[date.getMonth()];
  
  const random = Math.floor(100 + Math.random() * 900); // Nomor acak 3 digit
  const hours = ("0" + date.getHours()).slice(-2);
  const minutes = ("0" + date.getMinutes()).slice(-2);

  // Format hasil: INV/MD/XI/3741523
  return `INV/MD/${monthRoman}/${random}${hours}${minutes}`;
}

    document.getElementById('autoInvoice').textContent = generateInvoiceNumber();

    // Hitung total
    function attachListeners() {
      document.querySelectorAll('.jumlah, .hargaSatuan').forEach(input => {
        input.addEventListener('input', calcTotal);
      });
      document.querySelectorAll('.removeRow').forEach(btn => {
        btn.addEventListener('click', function() {
          this.closest('tr').remove();
          updateNo();
          calcTotal();
        });
      });
    }

    function updateNo() {
      document.querySelectorAll('#produkBody tr').forEach((row, i) => {
        row.querySelector('td:first-child').textContent = i + 1;
      });
    }

   function calcTotal() {
  let total = 0;
  document.querySelectorAll('#produkBody tr').forEach(row => {
    const j = parseFloat(row.querySelector('.jumlah').value) || 0;
    const h = parseFloat(row.querySelector('.hargaSatuan').value) || 0;
    const t = j * h;
    row.querySelector('.totalProduk').value = t.toLocaleString('id-ID');
    total += t;
  });
  document.getElementById('totalKeseluruhan').textContent = total.toLocaleString('id-ID');
  updateSisaPembayaran();
}

    attachListeners();

    // Tambah produk
    document.getElementById('tambahProduk').addEventListener('click', () => {
      const tbody = document.getElementById('produkBody');
      const no = tbody.rows.length + 1;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${no}</td>
        <td><input type="text" class="form-control namaProduk" required></td>
        <td><input type="number" class="form-control jumlah" min="1" required></td>
        <td><input type="number" class="form-control hargaSatuan" min="0" required></td>
        <td><input type="text" class="form-control totalProduk" readonly></td>
        <td><button type="button" class="btn btn-danger btn-sm removeRow">Hapus</button></td>`;
      tbody.appendChild(tr);
      attachListeners();
    });
// === HITUNG DP & SISA PEMBAYARAN ===
document.getElementById('dpInput').addEventListener('input', updateSisaPembayaran);

function updateSisaPembayaran() {
  const total = parseFloat(document.getElementById('totalKeseluruhan').textContent.replace(/\./g, '')) || 0;
  const dp = parseFloat(document.getElementById('dpInput').value) || 0;
  const sisa = total - dp;
  document.getElementById('sisaPembayaran').textContent = 'Rp ' + sisa.toLocaleString('id-ID');
}

    // Preview
    document.getElementById('previewBtn').addEventListener('click', function() {
      const nomorInvoice = document.getElementById('autoInvoice').textContent;
      const tanggal = document.getElementById('tanggal').value;
      const kepada = document.getElementById('kepada').value;
      const namaPemilik = document.getElementById('namaPemilik').value;
      const totalKeseluruhan = document.getElementById('totalKeseluruhan').textContent;

      let produkHtml = `
      <table class="table table-bordered mt-3">
        <thead><tr><th>No</th><th>Nama Produk</th><th>Jumlah</th><th>Harga Satuan</th><th>Total</th></tr></thead><tbody>`;
      document.querySelectorAll('#produkBody tr').forEach(row => {
        const no = row.querySelector('td:first-child').textContent;
        const nama = row.querySelector('.namaProduk').value;
        const jumlah = row.querySelector('.jumlah').value;
        const harga = row.querySelector('.hargaSatuan').value;
        const total = row.querySelector('.totalProduk').value;
        produkHtml += `<tr><td>${no}</td><td>${nama}</td><td>${jumlah}</td><td>Rp ${parseInt(harga).toLocaleString('id-ID')}</td><td>Rp ${total}</td></tr>`;
      });
      produkHtml += `</tbody></table>`;

      document.getElementById('previewContent').innerHTML = `
      <div id="pdfArea" class="pdf-preview">
        <div class="header-flex">
          <div class="header-left">
            <img src="logo.jpg" class="logo" alt="Logo">
            <div class="company-name">
              <h2>Konveksi Jasa Pembuatan Seragam</h2>
              <p>Kampung Babakan Rt.02 Rw.06 Kota Bekasi<br>Hp: 085716122202 / 08571644585</p>
            </div>
          </div>
          <div>
            <div class="invoice-title">INVOICE</div>
            <div><strong>No. Invoice:</strong> ${nomorInvoice}</div>
          </div>
        </div>
        <p class="mt-3"><strong>Kepada Yth</strong><br>${kepada}<br>Di Tempat</p>
        ${produkHtml}
        <h5 class="total-row mt-3">Total Keseluruhan: Rp ${totalKeseluruhan}</h5>
      
<p style="font-size:14px; margin-top:4px;">
  <strong>Catatan:</strong> Pembayaran DP (uang muka) telah diterima sejumlah Rp. ${parseFloat(document.getElementById('dpInput').value || 0).toLocaleString('id-ID')}.
</p>

<div style="text-align: right; margin-top: 10px;">
  <div style="background:#1976d2; color:white; padding:8px 16px; border-radius:6px; font-weight:bold; display:inline-block; min-width:200px;">
    Sisa Pembayaran: Rp ${(
      (parseFloat(document.getElementById('totalKeseluruhan').textContent.replace(/\./g,''))||0) -
      (parseFloat(document.getElementById('dpInput').value.replace(/\./g,''))||0)
    ).toLocaleString('id-ID')}
  </div>
</div>

        <div class="invoice-footer">
          <div>
            <h6>Pembayaran:</h6>
            <p>Bank BCA a/n <b>Darmin</b><br>No. Rek: <b>8415723942</b></p>
          </div>
          <div class="text-start">
            <p>Bekasi, ${tanggal}</p>
            <p>Hormat Kami,</p>
            <p>Muda Collection</p>
            <img src="stamp.png" class="signature" alt="Tanda Tangan">
            <p><strong>${namaPemilik}</strong></p>
          </div>
        </div>
      </div>`;

      document.getElementById('formMode').style.display = 'none';
      document.getElementById('previewMode').style.display = 'block';
      document.body.classList.add('preview-mode-active');
    });

    // Kembali ke form
    document.getElementById('backToForm').addEventListener('click', function() {
      document.getElementById('previewMode').style.display = 'none';
      document.getElementById('formMode').style.display = 'block';
      document.body.classList.remove('preview-mode-active');
    });

    // Download PDF
document.getElementById('downloadPdfFinal').addEventListener('click', function() {
  const element = document.getElementById('pdfArea');
  const kepada = document.getElementById('kepada').value || 'TanpaNama';
  const fileName = `Invoice-${kepada.replace(/\s+/g, '_')}.pdf`;

  // Pastikan elemen punya ukuran fix agar tidak terpotong
  element.style.width = '210mm'; // ukuran A4
  element.style.maxWidth = '210mm';
  element.style.margin = '0 auto';
  element.style.padding = '10mm';
  element.style.backgroundColor = '#ffffff';
  element.style.overflow = 'visible';
  element.style.transform = 'none';
  element.style.scale = '1';

  // Pakai konfigurasi yang menangkap seluruh area HTML
  const opt = {
    margin: 0,
    filename: fileName,
    image: { type: 'jpeg', quality: 1 },
    html2canvas: {
      scale: 3,            // semakin besar semakin tajam dan lengkap
      useCORS: true,
      scrollX: 0,
      scrollY: 0,
      windowWidth: document.body.scrollWidth,
      windowHeight: document.body.scrollHeight
    },
    jsPDF: {
      unit: 'mm',
      format: 'a4',
      orientation: 'portrait'
    },
    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
  };

  html2pdf().set(opt).from(element).save();
});

  </script>
</body>
</html>
