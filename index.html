<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invoice - Konveksi Jasa Pembuatan Seragam</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #e3f2fd, #bbdefb);
      color: #333;
      margin: 0;
      padding: 0;
    }
    .container {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      padding: 30px;
      margin-top: 20px;
    }
    .header-flex {
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 3px solid #1976d2;
      padding-bottom: 10px;
    }
    .header-left {
      display: flex;
      align-items: center;
    }
    .logo {
      width: 170px;
      margin-right: 15px;
    }
    .company-name h2 {
      margin: 0;
      color: #1976d2;
      font-weight: 700;
    }
    .invoice-title {
      font-size: 1.8rem;
      font-weight: bold;
      color: #1565c0;
      text-align: right;
    }
    .form-label {
      font-weight: 600;
      color: #424242;
    }
    .table th {
      background: #1976d2;
      color: #fff;
    }
    .table tbody tr:hover {
      background: #e3f2fd;
    }
    .total-row {
      font-weight: bold;
      color: #d32f2f;
      text-align: right;
    }
    .signature {
      max-width: 180px;
      margin-top: 5px;
    }
    .invoice-footer {
      display: flex;
      justify-content: space-between;
      margin-top: 40px;
    }
    .btn {
      border-radius: 25px;
      transition: 0.3s;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .preview-mode { display: none; }
    /* CSS khusus untuk PDF preview agar kecil dan responsif */
    .pdf-preview {
      font-size: 12px; /* Perkecil font */
      padding: 10px; /* Kurangi padding */
      line-height: 1.2; /* Rapatkan baris */
    }
    .pdf-preview .header-flex {
      padding-bottom: 5px;
    }
    .pdf-preview .logo {
      width: 80px; /* Perkecil logo */
    }
    .pdf-preview .company-name h2 {
      font-size: 1.2rem;
    }
    .pdf-preview .invoice-title {
      font-size: 1.4rem;
    }
    .pdf-preview .table {
      font-size: 11px;
    }
    .pdf-preview .total-row {
      font-size: 13px;
    }
    .pdf-preview .invoice-footer {
      margin-top: 20px;
    }
    .text-start p {
  margin-bottom: 4px;
  text-align: left;
}

  </style>
</head>
<body>
  <div class="container" id="invoiceContainer">
    
    <!-- Header -->
    <div class="header-flex">
      <div class="header-left">
        <img src="img/logo.jpg" class="logo" alt="Logo">
        <div class="company-name">
          <h2>Konveksi Jasa Pembuatan Seragam</h2>
          <p>Kampung babakan Rt.02 Rw.06 Kota Bekasi <br>Hp: 085716122202 / 08571644585</p>
        </div>
      </div>
      <div>
        <div class="invoice-title">INVOICE</div>
        <div><strong>No. Invoice:</strong> <span id="autoInvoice"></span></div>
      </div>
    </div>

    <!-- Form Mode -->
    <div id="formMode" class="mt-4">
      <form id="invoiceForm">
        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Tanggal Invoice</label>
            <input type="date" class="form-control" id="tanggal" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Kepada Yth</label>
            <input type="text" class="form-control" id="kepada" placeholder="Nama Penerima" required>
            <small class="text-muted">Di Tempat</small>
          </div>
        </div>

        <h5 class="mt-4">Produk</h5>
        <table class="table table-bordered" id="produkTable">
          <thead>
            <tr>
              <th>No</th>
              <th>Nama Produk</th>
              <th>Jumlah</th>
              <th>Harga Satuan</th>
              <th>Total</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody id="produkBody">
            <tr data-no="1">
              <td>1</td>
              <td><input type="text" class="form-control namaProduk" required></td>
              <td><input type="number" class="form-control jumlah" min="1" required></td>
              <td><input type="number" class="form-control hargaSatuan" min="0" required></td>
              <td><input type="text" class="form-control totalProduk" readonly></td>
              <td><button type="button" class="btn btn-danger btn-sm removeRow">Hapus</button></td>
            </tr>
          </tbody>
        </table>
        <button type="button" class="btn btn-primary mb-3" id="tambahProduk">Tambah Produk</button>

        <h5 class="total-row">Total Keseluruhan: Rp <span id="totalKeseluruhan">0</span></h5>

        <div class="invoice-footer">
          <div>
            <h6>Pembayaran:</h6>
            <p>Bank BCA a/n <b>Darmin</b><br>No. Rek: <b>8415723942</b></p>
          </div><br><br>>
          <div class="text-start">
            <p>Bekasi, ${tanggal}</p>
            <p>Hormat Kami,<br>Muda Collection</p>
            <img src="img/stamp.png" alt="Tanda Tangan" class="signature"><br>
            <label class="form-label mt-2">Nama Pemilik</label>
            <input type="text" class="form-control" id="namaPemilik" placeholder="Masukkan Nama Pemilik" required>
          </div>
        </div>

        <div class="text-center mt-4">
          <button type="button" class="btn btn-info me-2" id="previewBtn">Preview</button>
          <button type="submit" class="btn btn-success me-2" id="saveBtn">Save</button>
          <button type="button" class="btn btn-secondary" id="downloadPdfBtn">Download PDF</button>
        </div>
      </form>
    </div>

    <!-- Preview Mode -->
    <div id="previewMode" class="preview-mode mt-4">
      <div id="previewContent" class="pdf-preview"></div>
      <div class="text-center mt-3">
        <button class="btn btn-secondary" id="backToForm">Kembali ke Form</button>
        <button class="btn btn-success" id="downloadPdfFinal">Download PDF</button>
      </div>
    </div>
  </div>

  <script>
    // Generate nomor invoice otomatis
    function generateInvoiceNumber() {
      const date = new Date();
      const y = date.getFullYear().toString().slice(-2);
      const m = ("0" + (date.getMonth() + 1)).slice(-2);
      const d = ("0" + date.getDate()).slice(-2);
      const random = Math.floor(100 + Math.random() * 900);
      return `INV-${y}${m}${d}-${random}`;
    }
    document.getElementById('autoInvoice').textContent = generateInvoiceNumber();

    // Hitung total per produk & keseluruhan
    function attachListeners() {
      document.querySelectorAll('.jumlah, .hargaSatuan').forEach(input => {
        input.addEventListener('input', calcTotal);
      });
      document.querySelectorAll('.removeRow').forEach(btn => {
        btn.addEventListener('click', function() {
          this.closest('tr').remove();
          updateNo();
          calcTotal();
        });
      });
    }

    function updateNo() {
      document.querySelectorAll('#produkBody tr').forEach((row, i) => {
        row.querySelector('td:first-child').textContent = i + 1;
      });
    }

    function calcTotal() {
      let total = 0;
      document.querySelectorAll('#produkBody tr').forEach(row => {
        const j = parseFloat(row.querySelector('.jumlah').value) || 0;
        const h = parseFloat(row.querySelector('.hargaSatuan').value) || 0;
        const t = j * h;
        row.querySelector('.totalProduk').value = t.toLocaleString('id-ID');
        total += t;
      });
      document.getElementById('totalKeseluruhan').textContent = total.toLocaleString('id-ID');
    }
    attachListeners();

    // Tambah produk
    document.getElementById('tambahProduk').addEventListener('click', () => {
      const tbody = document.getElementById('produkBody');
      const no = tbody.rows.length + 1;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${no}</td>
        <td><input type="text" class="form-control namaProduk" required></td>
        <td><input type="number" class="form-control jumlah" min="1" required></td>
        <td><input type="number" class="form-control hargaSatuan" min="0" required></td>
        <td><input type="text" class="form-control totalProduk" readonly></td>
        <td><button type="button" class="btn btn-danger btn-sm removeRow">Hapus</button></td>`;
      tbody.appendChild(tr);
      attachListeners();
    });

    // Preview tampilan real invoice (dengan header lengkap dan class pdf-preview)
 document.getElementById('previewBtn').addEventListener('click', function() {
  const nomorInvoice = document.getElementById('autoInvoice').textContent;
  const tanggal = document.getElementById('tanggal').value;
  const kepada = document.getElementById('kepada').value;
  const namaPemilik = document.getElementById('namaPemilik').value;
  const totalKeseluruhan = document.getElementById('totalKeseluruhan').textContent;

  let produkHtml = `
  <table class="table table-bordered mt-3">
    <thead><tr><th>No</th><th>Nama Produk</th><th>Jumlah</th><th>Harga Satuan</th><th>Total</th></tr></thead><tbody>`;
  document.querySelectorAll('#produkBody tr').forEach(row => {
    const no = row.querySelector('td:first-child').textContent;
    const nama = row.querySelector('.namaProduk').value;
    const jumlah = row.querySelector('.jumlah').value;
    const harga = row.querySelector('.hargaSatuan').value;
    const total = row.querySelector('.totalProduk').value;
    produkHtml += `<tr><td>${no}</td><td>${nama}</td><td>${jumlah}</td><td>Rp ${parseInt(harga).toLocaleString('id-ID')}</td><td>Rp ${total}</td></tr>`;
  });
  produkHtml += `</tbody></table>`;

  // SATUKAN HEADER, ISI, DAN FOOTER KE DALAM previewContent
  document.getElementById('previewContent').innerHTML = `
  <div id="pdfArea" class="pdf-preview">
    <div class="header-flex">
      <div class="header-left">
        <img src="img/logo.jpg" class="logo" alt="Logo">
        <div class="company-name">
          <h2>Konveksi Jasa Pembuatan Seragam</h2>
          <p>Kampung babakan Rt.02 Rw.06 Kota Bekasi<br>Hp: 085716122202 / 08571644585</p>
        </div>
      </div>
      <div>
        <div class="invoice-title">INVOICE</div>
        <div><strong>No. Invoice:</strong> ${nomorInvoice}</div>
      </div>
    </div>

    <p class="mt-3"><strong>Kepada Yth</strong><br>${kepada}<br>Di Tempat</p>
    ${produkHtml}
    <h5 class="total-row mt-3">Total Keseluruhan: Rp ${totalKeseluruhan}</h5>

    <div class="invoice-footer">
      <div>
        <h6>Pembayaran:</h6>
        <p>Bank BCA a/n <b>Darmin</b><br>No. Rek: <b>8415723942</b></p>
      </div>
      <div class="text-start">
        <p>Bekasi, ${tanggal}</p>
        <p>Hormat Kami,</p>
        <p>Muda Collection</p>
        <img src="img/stamp.png" class="signature" alt="Tanda Tangan">
        <p><strong>${namaPemilik}</strong></p>
      </div>
    </div>
  </div>`;

  document.getElementById('formMode').style.display = 'none';
  document.getElementById('previewMode').style.display = 'block';
});


    // Kembali ke form
    document.getElementById('backToForm').addEventListener('click', function() {
      document.getElementById('previewMode').style.display = 'none';
      document.getElementById('formMode').style.display = 'block';
    });

    // Download PDF dari preview (landscape, kecil, responsif, auto-paging)
document.getElementById('downloadPdfFinal').addEventListener('click', function() {
  const element = document.getElementById('pdfArea');
  const opt = {
    margin: 0.2,
    filename: 'Invoice-Konveksi.pdf',
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true },
    jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' },
    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
  };

  // âœ… Cek tinggi konten dan sesuaikan ukuran halaman otomatis
  const contentHeight = element.scrollHeight;
  if (contentHeight < 1000) {
    opt.jsPDF.format = [210, contentHeight * 0.2645]; // konversi px ke mm
  }

  html2pdf().set(opt).from(element).save();
});

  </script>
</body>
</html>
